{% load  app_filters %}
{% load static %}
<script src={% static "image_preview.js" %}></script>

<script src="https://code.jquery.com/jquery-3.3.1.min.js" ></script>


<!-- show static headers if original not visible -->

<script>
    document.addEventListener("scroll", elementInViewport2);

    function elementInViewport2() {
        el = document.getElementById("table-head");
        var top = el.offsetTop;
        var left = el.offsetLeft;
        var width = el.offsetWidth;
        var height = el.offsetHeight;

        while(el.offsetParent) {
        el = el.offsetParent;
        top += el.offsetTop;
        left += el.offsetLeft;
        }
        if(
            top < (window.pageYOffset + window.innerHeight) &&
            left < (window.pageXOffset + window.innerWidth) &&
            (top + height) > window.pageYOffset &&
            (left + width) > window.pageXOffset
          )
        {
            document.getElementById("view-header").hidden = true;
        }
        else
        {
            document.getElementById("view-header").hidden = false;
        }
    }
    </script>

<!-- -- -- -- -- -- -- -- -- -- -- -->



{% if mode == "edit" %}
    <script>

        document.addEventListener("input", function (e) {
        console.log(e);
            if(e.target.getAttribute("value") != e.target.value && e.target.getAttribute("data-field"))
            {
                e.target.style.color = "green"
            }
            else
            {
                e.target.style.color = "black"
            }
            if(e.target.value=="" && e.target.getAttribute("data-field") == "name")
            {
                e.target.setAttribute("placeholder", `${e.target.getAttribute("value")} Будет удален`)
            }
            console.log(e.target);
            input_el = e.target;
            changes = JSON.parse(document.getElementById("changes").value);
            let id = input_el.getAttribute("data-id");
            let field = input_el.getAttribute("data-field");
            if (input_el.type == "checkbox")
            {
                changes[`${id}|${field}`] = input_el.checked == true;
            }
            else
            {
                changes[`${id}|${field}`] = input_el.value;
            }
            console.log(changes);
            document.getElementById("changes").value = JSON.stringify(changes)
            })
    </script>
{% endif %}
{% if table %}
    <div class="entry_count">Деталей найдено: {{ table|length }}</div>
<form method="post" enctype="multipart/form-data">{% csrf_token %}

    {% if mode == "edit" %}
        <input type="hidden" id="changes" name="changes" value="{}">
        <div class="even-space">
            <button type="submit" class="action-button-admin">Сохранить в БД</button>
        </div>

    {% endif %}

        <table id="table-universal" class="table table-hover" >
        <thead id="table-head">
            {% for head in headers %}
                <th class="th-inner {{ head }}" id="{{ head }}">{{ head }}</th>
            {% endfor %}
            </thead>

            <tbody>
                {% for row_index, item in table %}

                {% if item.photo_link %}

                        <img class="item_image" src="{{ item.photo_link }}" id="img{{ row_index }}" > <!-- adding hidden image on page -->

                {% endif %}

                    {% if mode == "edit" or not item.is_hidden %}
                    <tr>
                        {% for col_index, field in fields %}

                            <td {% if field == "name" %}id="{{ item.name }}"{% endif %} class="{% if field == "photo_link" and mode == "edit" %} row_oriented {% endif %}{% if field == "name" %} name_column{% endif %}">
                                {% if mode == "edit" %}
                                <input
                                    class="edit-table_input {% if field == "photo_link" %} photo_link_input{% endif %}"
                                    data-id="{{item.id}}"
                                    data-field="{{field}}"
                                    value="{{ item|get_model_field:field }}"
                                    type="{{ col_index|inp_type }}"

                                    {% if item.is_hidden %}
                                    checked="checked"
                                    {% endif %}

                                />

                                    {% if field == "photo_link" and item.photo_link %}

                                        <button class="reveal_img photo_text" id="{{ row_index }}open" type="button" onclick="open_image({{ row_index }})">
                                            Фото
                                        </button>

                                    {% endif %}



                                {% elif mode == "view" %}



                                    {% if field != "photo_link"%}
                                        {{ item|get_model_field:field }}
                                    {% else %}
                                        {% if item.photo_link %}
                                            <button id="{{ row_index }}open" type="button" class="reveal_img photo_text" onclick="open_image({{ row_index }})">
                                                Фото
                                            </button>
                                        {% endif %}
                                    {% endif %}

                                {% endif %}


                            </td>

                        {% endfor %}
                    </tr>
                    {% endif %}




                {% endfor %}
            </tbody>
        </table>
    </form>

    <!-- creating static headers if original not visible -->
    <table id="view-header" class="nav_header" hidden="true">
        <thead class="static-thead">

            {% for header in headers %}

                <th class="th-inner" id="{{ header|concatenate:"static" }}">
                    {{ header }}
                </th>

                <script>
                    table_head = $("#{{ header }}");
                    console.log({{ header }}, table_head);
                    static_header_element = document.getElementById("{{ header|concatenate:"static" }}");
                    console.log(static_header_element.style.width);
                    static_header_element.style.width = `${table_head[0].offsetWidth}px`;
                </script>



            {% endfor %}
        </thead>
    </table>
<!-- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -->

{% endif %}








